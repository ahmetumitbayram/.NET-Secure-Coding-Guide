# 18. Kimlik Doğrulama Zafiyetleri

## 18.1 Kimlik Doğrulama (Authentication) Nedir?

Kimlik doğrulama, kullanıcının kim olduğunu kanıtlaması sürecidir. Uygulamalar, bu süreci genellikle kullanıcı adı/parola kombinasyonu, token, sertifika veya çok faktörlü doğrulama ile yürütür.

Doğrulama işleminin hatalı tasarlanması veya uygulanması, sistemin yetkisiz kullanıcılar tarafından ele geçirilmesine yol açabilir.

---

## 18.2 Zayıf Kimlik Doğrulama Hataları

| Zafiyet                             | Açıklama                                                        |
| ----------------------------------- | --------------------------------------------------------------- |
| Parola brute-force’a açık           | Hesap kilitleme mekanizması yoksa saldırgan deneme yapabilir    |
| Varsayılan hesaplar                 | Uygulamada admin\:admin gibi varsayılan kullanıcılar bırakılmış |
| Token validasyon eksikliği          | JWT gibi token'lar imza kontrolü olmadan kabul ediliyor         |
| Session Fixation                    | Sabit session ID ile oturum devralma mümkün                     |
| Parola sıfırlama güvenliksizlikleri | Token tahmini, e-posta ifşası gibi hatalar                      |

---

## 18.3 ASP.NET Core Kimlik Doğrulama Yapısı

ASP.NET Core Identity kullanılarak standart kimlik doğrulama işlemleri güvenli şekilde entegre edilebilir:

```csharp
services.AddDefaultIdentity<IdentityUser>()
    .AddEntityFrameworkStores<ApplicationDbContext>();
```

```csharp
app.UseAuthentication();
app.UseAuthorization();
```

---

## 18.4 Parola Politikası

| Kriter               | Önerilen Değer                              |
| -------------------- | ------------------------------------------- |
| Minimum uzunluk      | 10+ karakter                                |
| Karakter çeşitliliği | Büyük/küçük harf, sayı, özel karakter       |
| Parola geçmişi       | Son 5 parolayı tekrar kullanamama           |
| Parola saklama       | Hashlenmiş ve salt'lanmış (PBKDF2 / bcrypt) |
| Parola süresi        | Opsiyonel olarak 6 ayda bir değişim         |

---

## 18.5 Parola Doğrulama (Hash)

### Güvensiz:

```csharp
var hash = SHA1.Create().ComputeHash(Encoding.UTF8.GetBytes(password));
```

### Güvenli:

```csharp
var hasher = new PasswordHasher<IdentityUser>();
var result = hasher.VerifyHashedPassword(user, storedHash, inputPassword);
```

---

## 18.6 Brute-Force ve Rate-Limiting

Sisteme ardışık parola denemeleri ile brute-force saldırısı yapılmasını engellemek için:

* Deneme sayısı sınırlandırılmalı (örneğin 5 defa)
* Hesap geçici olarak kilitlenmeli
* IP bazlı rate limiting uygulanmalı
* Captcha doğrulaması eklenmeli

```csharp
options.Lockout.DefaultLockoutTimeSpan = TimeSpan.FromMinutes(15);
options.Lockout.MaxFailedAccessAttempts = 5;
```

---

## 18.7 Çok Faktörlü Kimlik Doğrulama (2FA / MFA)

Sadece parola ile giriş yapmak yerine:

* SMS OTP
* TOTP (Time-based One Time Password) — Google Authenticator
* Donanımsal anahtar (YubiKey)
* Email ile doğrulama

```csharp
await _signInManager.TwoFactorSignInAsync("Authenticator", code, false, rememberMe);
```

---

## 18.8 JWT Token Güvenliği

JWT (JSON Web Token) token’ları imzalı ve base64-encoded’dır.

### Güvenlik Kontrolleri:

* Token süresi kısa olmalı (örnek: 15dk)
* Refresh token mekanizması kullanılmalı
* İmza doğrulaması her istekte yapılmalı
* Token içinde sensitive veri taşınmamalı

```csharp
services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options => {
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuerSigningKey = true,
            //...
        };
    });
```

---

## 18.9 Session Yönetimi

### Riskli Davranışlar:

* Session ID'lerin tahmin edilebilir olması
* Session Fixation (kullanıcı login olmadan önce session ID verilmesi)
* Oturum süresinin sınırsız olması

### Güvenli Öneriler:

* Session ID rastgele olmalı (GUID)
* Login sonrası yeni session ID oluşturulmalı
* Oturum zaman aşımı tanımlanmalı

```csharp
services.AddSession(options =>
{
    options.IdleTimeout = TimeSpan.FromMinutes(20);
});
```

---

## 18.10 Parola Sıfırlama Zafiyetleri

### Güvensiz Örnekler:

* Token sabit, tahmin edilebilir (`reset/12345`)
* E-posta adresi üzerinden kullanıcı ifşası
* Token süresi çok uzun

### Güvenli Tasarım:

* Token rastgele ve zamanla sınırlı olmalı
* Kullanıcıya ait e-posta/ID bilgilerinin ifşası engellenmeli
* Süre dolunca token geçersiz olmalı

---

## 18.11 Gerçek Dünya Örneği

**Uber Parola Sıfırlama Açığı**

Uber’in bir dönemki parola sıfırlama sisteminde token kontrolü eksikti ve e-posta bilgisi bilinen bir kullanıcıya ait hesap kolaylıkla ele geçirilebiliyordu. Gerekli kimlik doğrulama adımları atlanmıştı.

---

## 18.12 Koruma Checklist

* [ ] Parolalar güvenli algoritmalarla hash’leniyor mu?
* [ ] Brute-force koruması aktif mi?
* [ ] Çok faktörlü kimlik doğrulama mevcut mu?
* [ ] Session ID login sonrası yeniden oluşturuluyor mu?
* [ ] JWT imzası ve süresi doğrulanıyor mu?
* [ ] Parola sıfırlama token’ları güvenli şekilde üretiliyor mu?
* [ ] Token içinde kişisel bilgi taşınıyor mu?

Kimlik doğrulama, güvenli bir sistemin ilk savunma hattıdır. Zayıf bir kimlik doğrulama mekanizması, tüm diğer güvenlik önlemlerini geçersiz kılabilir. Bu nedenle, sadece teknik olarak değil, kullanıcı deneyimi açısından da dikkatli tasarlanmalı ve güvenli hale getirilmelidir.

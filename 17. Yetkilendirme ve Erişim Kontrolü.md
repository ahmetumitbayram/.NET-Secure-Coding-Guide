# 17. Yetkilendirme ve Erişim Kontrolü

## 17.1 Yetkilendirme Nedir?

Yetkilendirme (Authorization), kimliği doğrulanmış bir kullanıcının hangi kaynaklara veya işlevlere erişebileceğini belirleyen süreçtir.

Kimlik doğrulama (authentication), "kimsin?" sorusunu cevaplarken; yetkilendirme, "neyi yapabilirsin?" sorusunu cevaplar.

---

## 17.2 Yetkilendirme Türleri

| Tür                                   | Açıklama                                                           |
| ------------------------------------- | ------------------------------------------------------------------ |
| Role-Based Access Control (RBAC)      | Kullanıcılara roller atanır ve roller üzerinden erişim tanımlanır  |
| Claims-Based Access Control           | Kullanıcıya özel iddialar (claims) üzerinden yetkilendirme yapılır |
| Attribute-Based Access Control (ABAC) | Kullanıcı, kaynak ve ortam niteliklerine göre erişim belirlenir    |

---

## 17.3 ASP.NET Core’da Yetkilendirme

### 17.3.1 `[Authorize]` Kullanımı

```csharp
[Authorize]
public IActionResult Dashboard()
{
    return View();
}
```

### 17.3.2 Rol Bazlı Yetki

```csharp
[Authorize(Roles = "Admin")]
public IActionResult AdminPanel()
{
    return View();
}
```

### 17.3.3 Policy Tabanlı Yetkilendirme

```csharp
services.AddAuthorization(options =>
{
    options.AddPolicy("HRPolicy", policy =>
        policy.RequireClaim("Department", "HR"));
});
```

```csharp
[Authorize(Policy = "HRPolicy")]
public IActionResult HRDocs()
{
    return View();
}
```

---

## 17.4 Erişim Kontrol Hataları

| Hata                                    | Açıklama                                                   |
| --------------------------------------- | ---------------------------------------------------------- |
| `[AllowAnonymous]` unutulmuş            | Giriş yapılmadan erişim açık kalır                         |
| Yetki kontrolü sadece UI seviyesinde    | Arka uçta kontrol yoksa API üzerinden erişim mümkündür     |
| IDOR (Insecure Direct Object Reference) | Başka kullanıcıya ait kaynaklara erişim kontrolsüz yapılır |
| Rol kontrolü eksik                      | `/admin/delete` endpoint’ine herkes erişebiliyor           |
| CSRF ile erişim zincirlemesi            | Kullanıcının adına izinli işlem yapılması                  |

---

## 17.5 IDOR (Doğrudan Nesne Referansı)

### Tehlikeli Örnek:

```csharp
// /order/details?id=145
var order = db.Orders.First(o => o.Id == Request.Query["id"]);
```

Saldırgan `id=146` diyerek başka bir kullanıcıya ait siparişi görüntüleyebilir.

### Güvenli Örnek:

```csharp
var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
var order = db.Orders.First(o => o.Id == id && o.UserId == userId);
```

---

## 17.6 Güvenlik Testi

| Test                           | Açıklama                                    |
| ------------------------------ | ------------------------------------------- |
| Yetki olmadan endpoint erişimi | 401/403 dönmesi gerekir                     |
| ID manipülasyonu               | Kendi dışındaki kaynaklara erişim denenmeli |
| Yetki atlaması senaryoları     | `[Authorize]` eksik endpoint’ler aranmalı   |
| UI güvenli ama API açık mı?    | JavaScript/HTTP istekleri analiz edilmeli   |

---

## 17.7 Gerçek Dünya Örneği

**Facebook / Instagram IDOR Zafiyetleri**

Birden fazla güvenlik araştırmacısı, mobil API çağrıları üzerinde kullanıcı ID’sini değiştirerek başka kullanıcıların fotoğraflarını, DM’lerini, e-posta adreslerini görebildiklerini raporlamıştır.

---

## 17.8 RBAC Uygulama Örneği

```csharp
public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services.AddAuthorization(options =>
        {
            options.AddPolicy("OnlyAdmins", policy =>
                policy.RequireRole("Admin"));
        });
    }
}
```

```csharp
[Authorize(Policy = "OnlyAdmins")]
public IActionResult DeleteUser(int id) => View();
```

---

## 17.9 Claims Bazlı Yetki

```csharp
[Authorize(Policy = "HRPolicy")]
public IActionResult ViewSalaryData()
{
    return View();
}
```

`User.Claims` üzerinden alınan bilgilerle detaylı yetkilendirme senaryoları uygulanabilir.

---

## 17.10 Koruma Checklist

* [ ] Tüm erişim noktaları yetki kontrolüne sahip mi?
* [ ] UI seviyesindeki kontrol, API katmanında da var mı?
* [ ] Her kullanıcı sadece kendine ait verilere erişebiliyor mu?
* [ ] IDOR testi yapıldı mı?
* [ ] `[AllowAnonymous]` sadece gerektiği yerlerde mi kullanılmış?
* [ ] Rol/claim tabanlı erişim denetimleri uygulanmış mı?
* [ ] Log'larda yetkisiz erişim denemeleri takip ediliyor mu?

Yetkilendirme, güvenliğin merkezinde yer alır. En sık yapılan hatalardan biri, yalnızca frontend tarafında yetki kontrolü yapıp backend’i açık bırakmaktır. Sağlam bir erişim kontrol mekanizması, hem yetki atlamalarını hem de veri sızıntılarını engeller. Kontrollü erişim, kullanıcıların sadece sahip olması gereken bilgilere erişmesini garanti altına alır.
